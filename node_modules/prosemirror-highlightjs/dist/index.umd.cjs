(function(u,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("prosemirror-view"),require("prosemirror-state")):typeof define=="function"&&define.amd?define(["exports","prosemirror-view","prosemirror-state"],h):(u=typeof globalThis<"u"?globalThis:u||self,h(u["prosemirror-highlightjs"]={},u.prosemirrorView,u.prosemirrorState))})(this,function(u,h,P){"use strict";var D=Object.defineProperty;var S=(u,h,P)=>h in u?D(u,h,{enumerable:!0,configurable:!0,writable:!0,value:P}):u[h]=P;var L=(u,h,P)=>(S(u,typeof h!="symbol"?h+"":h,P),P);function k(m,e){const t=[];return e.includes("doc")&&t.push({node:m,pos:-1}),m.descendants((r,c)=>{if(r.isBlock&&e.indexOf(r.type.name)>-1)return t.push({node:r,pos:c}),!1}),t}function x(m,e,t,r,c){if(!m||!m.nodeSize||!(t!=null&&t.length)||!r)return[];const p=k(m,t);let f=[];return p.forEach(i=>{if(c!=null&&c.preRenderer){const g=c.preRenderer(i.node,i.pos);if(g){f=[...f,...g];return}}const n=r(i.node);if(n&&!e.getLanguage(n))return;const s=n?e.highlight(i.node.textContent,{language:n}):e.highlightAuto(i.node.textContent);!n&&s.language&&(c==null?void 0:c.autohighlightCallback)&&c.autohighlightCallback(i.node,i.pos,s.language);const o=s._emitter,d=new N(o,i.pos,o.options.classPrefix).value(),l=[];d.forEach(g=>{if(!g.scope)return;const C=h.Decoration.inline(g.from,g.to,{class:g.classes});l.push(C)}),c!=null&&c.postRenderer&&c.postRenderer(i.node,i.pos,l),f=[...f,...l]}),f}class N{constructor(e,t,r){L(this,"buffer");L(this,"nodeQueue");L(this,"classPrefix");L(this,"currentPosition");this.buffer=[],this.nodeQueue=[],this.classPrefix=r,this.currentPosition=t+1,e.walk(this)}get currentNode(){return this.nodeQueue.length?this.nodeQueue.slice(-1):null}addText(e){!this.currentNode||(this.currentPosition+=e.length)}openNode(e){let t=e.scope||"";e.sublanguage?t=`language-${t}`:t=this.expandScopeName(t);const r=this.newNode();r.scope=e.scope,r.classes=t,r.from=this.currentPosition,this.nodeQueue.push(r)}closeNode(e){const t=this.nodeQueue.pop();if(!t)throw"Cannot close node!";if(t.to=this.currentPosition,e.scope!==t.scope)throw"Mismatch!";this.buffer.push(t)}value(){return this.buffer}newNode(){return{from:0,to:0,scope:void 0,classes:""}}expandScopeName(e){if(e.includes(".")){const t=e.split("."),r=t.shift()||"";return[`${this.classPrefix}${r}`,...t.map((c,p)=>`${c}${"_".repeat(p+1)}`)].join(" ")}return`${this.classPrefix}${e}`}}class w{constructor(e){L(this,"cache");this.cache={...e}}get(e){return this.cache[e]||null}set(e,t,r){e<0||(this.cache[e]={node:t,decorations:r})}replace(e,t,r,c){this.remove(e),this.set(t,r,c)}remove(e){delete this.cache[e]}invalidate(e){const t=new w(this.cache),r=e.mapping;return Object.keys(this.cache).forEach(c=>{const p=+c;if(p<0)return;const f=r.mapResult(p),i=e.doc.nodeAt(f.pos),{node:n,decorations:s}=this.get(p);if(f.deleted||!(i!=null&&i.eq(n)))t.remove(p);else if(p!==f.pos){const o=s.map(a=>a.map(r,0,0)).filter(a=>a!==null);t.replace(p,f.pos,i,o)}}),t}}function v(m,e=["code_block"],t,r){const c=t||function(n){const s=n.attrs.detectedHighlightLanguage,o=n.attrs.params;return s||(o==null?void 0:o.split(" ")[0])||""},p=r||function(n,s,o,a){const d=s.attrs||{};return d.detectedHighlightLanguage=a,n.setNodeMarkup(o,void 0,d)},f=(n,s)=>{const o=[];return{content:x(n,m,e,c,{preRenderer:(d,l)=>{var g;return(g=s.get(l))==null?void 0:g.decorations},postRenderer:(d,l,g)=>{s.set(l,d,g)},autohighlightCallback:(d,l,g)=>{o.push({node:d,pos:l,language:g})}}),autodetectedLanguages:o}},i=new P.PluginKey;return new P.Plugin({key:i,state:{init(n,s){const o=new w({}),a=f(s.doc,o);return{cache:o,decorations:h.DecorationSet.create(s.doc,a.content),autodetectedLanguages:a.autodetectedLanguages}},apply(n,s){const o=s.cache.invalidate(n);if(!n.docChanged)return{cache:o,decorations:s.decorations.map(n.mapping,n.doc),autodetectedLanguages:[]};const a=f(n.doc,o);return{cache:o,decorations:h.DecorationSet.create(n.doc,a.content),autodetectedLanguages:a.autodetectedLanguages}}},props:{decorations(n){var s;return(s=this.getState(n))==null?void 0:s.decorations}},view(n){const s=o=>{const a=i.getState(o.state);if(!a||!a.autodetectedLanguages.length)return;let d=o.state.tr;a.autodetectedLanguages.forEach(l=>{l.language&&(d=p(d,l.node,l.pos,l.language)||d)}),d=d.setMeta("addToHistory",!1),o.dispatch(d)};return s(n),{update:s}}})}u.DecorationCache=w,u.getHighlightDecorations=x,u.highlightPlugin=v,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
