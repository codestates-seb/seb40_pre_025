(function(n,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("@lezer/common"),require("@lezer/highlight"),require("prosemirror-view"),require("prosemirror-state")):typeof define=="function"&&define.amd?define(["exports","@lezer/common","@lezer/highlight","prosemirror-view","prosemirror-state"],o):(n=typeof globalThis<"u"?globalThis:n||self,o(n["prosemirror-highlightjs"]={},n.common,n.highlight,n.prosemirrorView,n.prosemirrorState))})(this,function(n,o,d,D,S){"use strict";var y=Object.defineProperty;var F=(n,o,d)=>o in n?y(n,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):n[o]=d;var w=(n,o,d)=>(F(n,typeof o!="symbol"?o+"":o,d),d);function z(f,t){const c=[];return t.includes("doc")&&c.push({node:f,pos:-1}),f.descendants((a,r)=>{if(a.isBlock&&t.indexOf(a.type.name)>-1)return c.push({node:a,pos:r}),!1}),c}function q(f,t,c,a,r){if(!f||!f.nodeSize||!(c!=null&&c.length)||!a)return[];const h=z(f,c);let g=[];return h.forEach(e=>{var v;let s;r!=null&&r.preRenderer&&(s=(v=r.preRenderer(e.node,e.pos))!=null?v:void 0);const i=a(e.node)||"*",u=t[i]||t["*"]||null;if(!u)return;const m=u.parse(e.node.textContent,s),l=[];d.highlightTree(m,(r==null?void 0:r.highlighter)||d.classHighlighter,(R,k,C)=>{const j=D.Decoration.inline(R+e.pos+1,k+e.pos+1,{class:C});l.push(j)}),r!=null&&r.postRenderer&&r.postRenderer(e.node,e.pos,o.TreeFragment.addTree(m)),g=[...g,...l]}),g}class p{constructor(t){w(this,"cache");this.cache={...t}}get(t){return this.cache[t]||null}set(t,c,a){t<0||(this.cache[t]={node:c,fragments:a})}replace(t,c,a,r){this.remove(t),this.set(c,a,r)}remove(t){delete this.cache[t]}invalidate(t){const c=new p(this.cache),a=t.mapping;return Object.keys(this.cache).forEach(r=>{const h=+r;if(h<0)return;const g=a.mapResult(h),e=t.doc.nodeAt(g.pos),{node:s,fragments:i}=this.get(h),u=t.mapping.maps.flatMap(m=>{const l=[];return m.forEach((v,R,k,C)=>{l.push({fromA:v,toA:R,fromB:k,toB:C})}),l});g.deleted||!(e!=null&&e.eq(s))?c.remove(h):h!==g.pos&&c.replace(h,g.pos,e,o.TreeFragment.applyChanges(i,u))}),c}}function P(f,t=["code_block"],c,a){const r=c||function(e){const s=e.attrs.detectedHighlightLanguage,i=e.attrs.params;return s||(i==null?void 0:i.split(" ")[0])||""},h=(e,s)=>({content:q(e,f,t,r,{preRenderer:(u,m)=>{var l;return(l=s.get(m))==null?void 0:l.fragments},postRenderer:(u,m,l)=>{s.set(m,u,l)},highlighter:a})}),g=new S.PluginKey;return new S.Plugin({key:g,state:{init(e,s){const i=new p({}),u=h(s.doc,i);return{cache:i,decorations:D.DecorationSet.create(s.doc,u.content)}},apply(e,s){const i=s.cache.invalidate(e);if(!e.docChanged)return{cache:i,decorations:s.decorations.map(e.mapping,e.doc)};const u=h(e.doc,i);return{cache:i,decorations:D.DecorationSet.create(e.doc,u.content)}}},props:{decorations(e){var s;return(s=this.getState(e))==null?void 0:s.decorations}}})}n.TreeFragmentCache=p,n.getHighlightDecorations=q,n.highlightPlugin=P,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
